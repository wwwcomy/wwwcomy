<?xml version="1.0" encoding="UTF-8"?>
<Haiyan xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../haiyan.xsd">
	<table name="T_WM_OUTPREDTL" realTable="T_WM_OUTPREDTL" description="出库子订单" colspan="6">
		<id name="ITEM_ID" description="ITEM_ID" javaType="string">
			<component type="hidden" url=""/>
		</id>
		<field name="ORDER_ID_SUB" description="订单-子订单" javaType="string" lazyLoad="false">
			<component type="text" readOnly="true" colspan="1"/>
			<listColumn noedit="false" noquery="false" width="150"/>
		</field>
		<field name="ITEM_ID_PK" description="增加索引字段" javaType="bigDecimal">
			<component type="readOnlyText"/>
			<listColumn noquery="true"/>
		</field>
		<field name="SUBORDERID" description="子订单ID" javaType="string">
			<component type="readOnlyText"/>
		</field>
		<field name="OUT_SUB_CODE" description="出库:子订单:商品号" javaType="string" length="500">
			<component type="readOnlyText"/>
		</field>
		<field name="ORDER_ID" description="出库单号" javaType="string"><!-- ORDER_ID==V_WM_OUT.ID==V_WM_OUT.ORDER_ID -->
			<component type="readOnlyText"/>
			<queryCondition type="equal"/>
		</field>
		<field name="OUT_CODE" description="出库:商品号" javaType="string" length="500">
			<component type="readOnlyText"/>
		</field>
		<field name="PRODUCTID" description="EDP商品" javaType="string" >
			<component type="combo" readOnly="false" displayReferenceField="WMCODE,NAME" referenceField="ID" referenceTable="T_WM_SDBPRODUCT" associatedFields="WMCODE,NAME,PACKING_NUM,SUPP_CODE,IN_PRICE" />
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="PRODUCT_ID" description="SDB商品ID" javaType="string" >
			<component type="hidden" readOnly="false" />
			<queryCondition type="equal"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="NAME" description="产品名称" displayOnly="true" javaType="string" lazyLoad="false">
			<component type="text" readOnly="true" displayReferenceField="NAME"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="WMCODE" description="货号" displayOnly="true" javaType="string" lazyLoad="false">
			<component type="text" readOnly="true" displayReferenceField="WMCODE"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="SUPP_CODE" description="供应商自有货号" displayOnly="true" javaType="string">
			<component type="text" readOnly="true" displayReferenceField="SUPP_CODE"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="PRE" description=" " displayOnly="true" javaType="string" lazyLoad="false">
			<component type="button" readOnly="true" renderer="renderPre" /><!-- -->
			<listColumn noedit="false" noquery="false" width="70"/>
		</field>
		<field name="AUDIT" description=" " displayOnly="false" javaType="string" lazyLoad="false">
			<component type="button" readOnly="true"/><!--renderer="renderAudit" -->
			<listColumn noedit="true" noquery="true" width="70"/>
		</field>
		<field name="UNAUDIT" description=" " displayOnly="false" javaType="string" lazyLoad="false">
			<component type="button" readOnly="true"/><!--renderer="renderUnAudit" -->
			<listColumn noedit="true" noquery="true" width="70"/>
		</field>
		<field name="OUT_COUNT" description="订单数量" javaType="bigDecimal" defaultValue="0">
			<component type="text" readOnly="true"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="OUT_PCOUNT" description="(额度)分配数量" javaType="bigDecimal" defaultValue="0">
			<component type="text" readOnly="true"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="PRO_COUNT" description="(SDB表)应出库数量" javaType="bigDecimal" defaultValue="0">
			<component type="text" readOnly="false"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="OUT_RCOUNT" description="实际出库数量" javaType="bigDecimal" defaultValue="0">
			<component type="text" readOnly="false"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="CONTRA_INPRICE" description="合同进货单价" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="false" displayReferenceField="CONTRA_INPRICE"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="IN_PRICE" description="进货单价" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="false" displayReferenceField="IN_PRICE"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="OUT_PRICE" description="EDP销售单价" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="true"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="OUT_ALL_PRICE" description="EDP销售总价" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="true" />
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="PACKING_NUM" description="每箱个数" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="true" colspan="1" displayReferenceField="PACKING_NUM"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="CAPACITYNUM" description="每箱体积(m3)" displayOnly="false" javaType="bigDecimal">
			<component type="text" readOnly="true" maxFractionDigit="3" minFractionDigit="3"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="WEIGHTNUM" description="每箱重量(g)" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="true" />
			<listColumn noedit="false" noquery="false"/>
		</field>
		
		<field name="SUPPLIER" description="供应商" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="true" colspan="1"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="WAREHOUSE" description="出库仓库" displayOnly="false" javaType="string" lazyLoad="false" nullAllowed="false" ><!-- 分配后保存 -->
			<component type="combo" readOnly="true" colspan="1" displayReferenceField="NAME" referenceField="ID" referenceTable="T_DIC_WAREHOUSE_COMBO"/><!-- displayReferenceField="WAREHOUSE" -->
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="All_CAPACITYNUM" description="总体积(m3)" displayOnly="false" javaType="bigDecimal" lazyLoad="false">
			<component type="text" readOnly="true" maxFractionDigit="3" minFractionDigit="3"/>
			<listColumn noedit="false" noquery="false" width="95"/>
		</field>
		<field name="All_WEIGHTNUM" description="总重量(Kg)" displayOnly="false" javaType="bigDecimal" lazyLoad="false">
			<component type="text" readOnly="true"  maxFractionDigit="2" minFractionDigit="2"/>
			<listColumn noedit="false" noquery="false" width="95"/>
		</field>
		<field name="REMAINDER_NUM" description="尾箱数量" javaType="bigDecimal" defaultValue="0">
			<component type="text" readOnly="true"/>
			<listColumn noedit="false" noquery="false" width="65"/>
		</field>
		
		<field name="LOGISTICS_NAME" description="发货物流名称" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="false"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="LOGISTICS_CODE" description="发货物流单号" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="false"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="LOGISTICS_MEMO" description="发货情况简述" displayOnly="false" javaType="string" lazyLoad="false">
			<component type="text" readOnly="false"/>
			<listColumn noedit="false" noquery="false"/>
		</field>
		
		<field name="HYVERSION" description="HYVERSION" javaType="string">
			<component type="hidden" readOnly="false" />
			<listColumn noedit="false" noquery="false"/>
		</field>
		<field name="BILL_STATUS" javaType="string" description="单据明细状态">
			<component type="hidden" readOnly="true">
				<option displayName="待批" value="init"/>
				<option displayName="审批确认" value="audit"/>
			</component>
		</field>
		<field name="BILL_STATUS1" javaType="string" description="单据状态" defaultValue="init">
			<component type="dropdown" readOnly="true">
				<option displayName="初始" value="init"/>
				<option displayName="下发" value="send"/>
				<option displayName="待审批" value="foraudit"/>
				<option displayName="审批" value="audit"/>
			</component>
		</field>
		<!--
		<querySQL methodName="exp"><![CDATA[
			{(select distinct(PRODUCTID)
				from T_WM_OUTPRE)}
		]]></querySQL>
		-->
		
		<!-- 
			 -->
		
		<queryFilter>
			<pluggedFilter methodName="exp" parameter="If(IsEmpty(GetPara(SUBORDER_ID)),{},{and t_1.SUBORDERID = }&amp;GetPara(SUBORDER_ID))"/>
		</queryFilter>
	
		<!-- -->
		<role name="user sp">
			<disComponent name="PRE AUDIT UNAUDIT"/>
		</role>
		<role name="admin boss manager pe ac wm">
		</role>
		<pluginInterceptor methodName="bsh" pluginName="refreshOne" type="after"><![CDATA[
			void refreshDB() throws Throwable {
				String sql1 = "delete from T_WM_OUTPRE where ITEM_ID=?";
				String sql2 = "insert into  T_WM_OUTPRE(WAREHOUSE,NAME,ITEM_ID,ORDER_ID,OUT_CODE,ITEM_ID_PK,PRODUCTID,PRODUCT_ID,WMCODE,SUPP_CODE,OUT_COUNT,OUT_PCOUNT,OUT_RCOUNT,IN_PRICE,OUT_PRICE,PRO_COUNT,OUT_ALL_PRICE,PACKING_NUM,CAPACITYNUM,WEIGHTNUM,SUPPLIER,All_CAPACITYNUM,All_WEIGHTNUM,REMAINDER_NUM,LOGISTICS_NAME,LOGISTICS_CODE,LOGISTICS_MEMO,HYVERSION,BILL_STATUS) (select WAREHOUSE,NAME,ITEM_ID,ORDER_ID,OUT_CODE,ITEM_ID_PK,PRODUCTID,PRODUCT_ID,WMCODE,SUPP_CODE,OUT_COUNT,OUT_PCOUNT,OUT_RCOUNT,IN_PRICE,OUT_PRICE,PRO_COUNT,OUT_ALL_PRICE,PACKING_NUM,CAPACITYNUM,WEIGHTNUM,SUPPLIER,All_CAPACITYNUM,All_WEIGHTNUM,REMAINDER_NUM,LOGISTICS_NAME,LOGISTICS_CODE,LOGISTICS_MEMO,HYVERSION,BILL_STATUS from V_WM_OUTPRE where ITEM_ID=?)";
				final DBManager dbm = context.getDBM();
				dbm.executeUpdatePre(sql1, new Object[]{form.get("ITEM_ID")}, null);
				dbm.executeUpdatePre(sql2, new Object[]{form.get("ITEM_ID")}, null);
			}
			refreshDB();
		]]></pluginInterceptor>
		<pluginInterceptor methodName="bsh" pluginName="refreshDB" type="after"><![CDATA[
			com.haiyan.genmis.core.right.User user = context.getUser();
			boolean admin = com.haiyan.genmis.core.right.RightUtil.isUserInRole(user, "admin");
			if (!admin)
				throw new Warning("没有权限");
			void refreshDB() throws Throwable {
				String sql1 = "delete from T_WM_OUTPRE";
				String sql2 = "insert into  T_WM_OUTPRE(WAREHOUSE,NAME,ITEM_ID,ORDER_ID,OUT_CODE,ITEM_ID_PK,PRODUCTID,PRODUCT_ID,WMCODE,SUPP_CODE,OUT_COUNT,OUT_PCOUNT,OUT_RCOUNT,IN_PRICE,OUT_PRICE,PRO_COUNT,OUT_ALL_PRICE,PACKING_NUM,CAPACITYNUM,WEIGHTNUM,SUPPLIER,All_CAPACITYNUM,All_WEIGHTNUM,REMAINDER_NUM,LOGISTICS_NAME,LOGISTICS_CODE,LOGISTICS_MEMO,HYVERSION,BILL_STATUS) (select WAREHOUSE,NAME,ITEM_ID,ORDER_ID,OUT_CODE,ITEM_ID_PK,PRODUCTID,PRODUCT_ID,WMCODE,SUPP_CODE,OUT_COUNT,OUT_PCOUNT,OUT_RCOUNT,IN_PRICE,OUT_PRICE,PRO_COUNT,OUT_ALL_PRICE,PACKING_NUM,CAPACITYNUM,WEIGHTNUM,SUPPLIER,All_CAPACITYNUM,All_WEIGHTNUM,REMAINDER_NUM,LOGISTICS_NAME,LOGISTICS_CODE,LOGISTICS_MEMO,HYVERSION,BILL_STATUS from V_WM_OUTPRE)";
				final DBManager dbm = context.getDBM();
				dbm.executeUpdate(sql1, null);
				dbm.executeUpdate(sql2, null);
			}
			refreshDB();
		]]></pluginInterceptor>
		<!--
		<pluginInterceptor methodName="exp" parameter="
			Set(ITEM_ID,{CKItem_}&amp;GetNewID())
			" pluginName="edit" type="after"/>
			-->
		<pluginInterceptor methodName="exp" parameter="
			If(Get(BILL_STATUS)={audit},HidFlds(PRE,AUDIT,UNAUDIT)+DisFlds(OUT_COUNT,OUT_RCOUNT),true)
			+If(Or(isEmpty(Get(ORDER_ID)),SubStr(Get(ORDER_ID),0,2)={CK}),true,DisFlds(PRODUCTID,OUT_PRICE,OUT_ALL_PRICE))
			" pluginName="grid" />
		<!--
		<pluginInterceptor methodName="exp" parameter="
			If(SubStr(Get(ORDER_ID),0,2)={CK},Set(ITEM_ID_PK,0),Set(ITEM_ID_PK,Get(ITEM_ID)))
			+If(IsEmpty(Get(ITEM_ID_PK)),Set(ITEM_ID_PK,Get(ITEM_ID)),true)
			+NoCheck()+Save({T_WM_OUTPREPART},GetForm())+RunInterceptor(refreshOne)" pluginName="saveView" />
		<pluginInterceptor methodName="exp" parameter="DBSQL({update T_WM_OUTDETAIL set BILL_STATUS='audit' where HEADID='}&amp;Get(ORDER_ID)&amp;{' and PRODUCTID='}&amp;Get(PRODUCTID)&amp;{'})" pluginName="audit" />
		<pluginInterceptor methodName="exp" parameter="DBSQL({update T_WM_OUTDETAIL set BILL_STATUS='init' where HEADID='}&amp;Get(ORDER_ID)&amp;{' and PRODUCTID='}&amp;Get(PRODUCTID)&amp;{'})" pluginName="unaudit" />
		-->
		<!-- -->
		<pluginInterceptor methodName="exp" parameter="Save()" pluginName="saveView1" />
		<pluginOperation name="refreshDB" oprName="重载应出库明细" hostPage="query" tblevel="1" img="refresh" action="plugin({},{refreshDB})+brk()"/>
		
		<!--
		<pluginOperation name="saveView1" oprName="保存" hostPage="edit" tblevel="1" img="save" action="plugin({},{saveView})+brk()"/>	
		 -->
		<Operation queryPageDelete="false" save="false" saveAndAdd="false" saveAndAddCopy="false" />
	</table>
</Haiyan>
